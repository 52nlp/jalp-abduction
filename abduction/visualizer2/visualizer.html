<html>
<head>
<title>Visualizer</title>
<script type="text/javascript" src="js/ECOTree.js"></script>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.20.custom.min.js"></script>
<script type="text/javascript" src="output.js"></script>
<link type="text/css" href="css/smoothness/jquery-ui-1.8.20.custom.css" rel="stylesheet" />
<link type="text/css" rel="stylesheet" href="css/ECOTree.css" />
<link type="text/css" rel="stylesheet" href="css/style.css">
<script type="text/javascript">
var tableTemplate;
var currentDialogId = 1; 

var rootNode = null;
var myTree = null;
var nodeArray = [];
var query = null;

$(document).ready(init);

function init() {
	rootNode = $.parseJSON(data);
	query = rootNode.currentGoal;
	nodeArray[1]=rootNode;
	fillInfo();
	createTableTemplate();
	createDerivationTree();
}

function fillInfo() {
	$("#query").text(query);
}

function createTableTemplate () {
	tableTemplate = $('#dialogs').html();
	$('#dialogs').html("");
}

function createDerivationTree() {
	myTree = new ECOTree('myTree','tree');	
	myTree.config.useTarget = true;
	myTree.config.selectMode = ECOTree.SL_NONE;
	myTree.config.defaultNodeWidth = 150;
	myTree.config.defaultNodeHeight = 30;
	myTree.config.iSubtreeSeparation = 20;
	myTree.config.iSiblingSeparation = 15;
	myTree.config.iLevelSeparation = 30;
	
	var nodeStack = new Array();
	var currentNodeId = 2;	
				
	myTree.add(1,-1,rootNode.type,null,null,null,null,"Javascript:openInfoWindow(1)");
	
	for (var child in rootNode.children) {
		nodeStack.push({'node':rootNode.children[child],'parentId':1});
	}
	
	while (nodeStack.length>0) {
		var currentNode = nodeStack.pop();
		myTree.add(currentNodeId,currentNode.parentId,currentNode.node.type,null,null,null,null,"Javascript:openInfoWindow("+currentNodeId+")");
		for (var child in currentNode.node.children) {
			nodeStack.push({'node':currentNode.node.children[child],'parentId':currentNodeId});
		}
		nodeArray[currentNodeId]=currentNode.node;
		currentNodeId++;
	}
	myTree.UpdateTree();
}

function openInfoWindow(id) {
	var div = document.createElement('div');
	var dialogId = "dialog"+currentDialogId;
	$(div).attr("id",dialogId);
	currentDialogId++;
	$(div).html(tableTemplate);
	$("#dialogs").append(div);
	fillNode(nodeArray[id],dialogId);
	$("#"+dialogId).dialog({'height':'auto','width':'auto','resizable':false});
}

function fillNode(node,dialogId) {
	fillType(node.type,dialogId);
	fillCurrentGoal(node.currentGoal,dialogId);
	fillNestedDenials(node.nestedDenials,dialogId);
	fillNextGoals(node.nextGoals,dialogId);
	fillAssignments(node.assignments,dialogId);
	fillAbducibles(node.abducibles,dialogId);
	fillDenials(node.denials,dialogId);
	fillEqualities(node.equalities,dialogId);
	fillConstraints(node.constraints,dialogId);
	fillNodeMark(node.mark,dialogId);
}	

function fillType(type,dialogId) {
	$("#"+dialogId+" #dataTable #type").text(type);
}

function fillCurrentGoal(type,dialogId) {
	$("#"+dialogId+" #dataTable #current-goal").text(type);
}

function fillNestedDenials(denialArray, dialogId) {
	var ul,li;

	ul = document.createElement('ul');
	for (var denial in denialArray) {
		li = document.createElement('li');
		$(li).text(denialArray[denial]);
		ul.appendChild(li);
	}
	$("#"+dialogId+" #dataTable #nested-denials").html(ul);
}

function fillNextGoals(goalArray, dialogId) {
	var ul,li;

	ul = document.createElement('ul');
	for (var goal in goalArray) {
		li = document.createElement('li');
		$(li).text(goalArray[goal]);
		ul.appendChild(li);
	}
	$("#"+dialogId+" #dataTable #next-goals").html(ul);
}

function fillAssignments(assignments, dialogId) {
	var ul,li;

	ul = document.createElement('ul');
	for (var assignment in assignments) {
		li = document.createElement('li');
		$(li).text(assignment+"/"+assignments[assignment]);
		ul.appendChild(li);
	}
	$("#"+dialogId+" #dataTable #assignments").html(ul);
}

function fillAbducibles(abducibleArray, dialogId) {
	var ul,li;

	ul = document.createElement('ul');
	for (var abducible in abducibleArray) {
		li = document.createElement('li');
		$(li).text(abducibleArray[abducible]);
		ul.appendChild(li);
	}
	$("#"+dialogId+" #dataTable #abducibles").html(ul);
}

function fillDenials(denialArray, dialogId) {
	var ul,li;

	ul = document.createElement('ul');
	for (var denial in denialArray) {
		li = document.createElement('li');
		$(li).text(denialArray[denial]);
		ul.appendChild(li);
	}
	$("#"+dialogId+" #dataTable #denials").html(ul);
}

function fillEqualities(equalityArray, dialogId) {
	var ul,li;

	ul = document.createElement('ul');
	for (var equality in equalityArray) {
		li = document.createElement('li');
		$(li).text(equalityArray[equality]);
		ul.appendChild(li);
	}
	$("#"+dialogId+" #dataTable #equalities").html(ul);
}

function fillConstraints(constraintArray, dialogId) {
	var ul,li;

	ul = document.createElement('ul');
	for (var constraint in constraintArray) {
		li = document.createElement('li');
		$(li).text(constraintArray[constraint]);
		ul.appendChild(li);
	}
	$("#"+dialogId+" #dataTable #constraints").html(ul);
}

function fillNodeMark(nodeMark, dialogId) {
	$("#"+dialogId+" #dataTable #mark").text(nodeMark);
}
</script>			
</head>
<body>
<div id="heading">
	<h1>JALP Visual Debugger</h1>
	<div class="header-border"></div>
</div>
<div id="info">
Query: <span id="query"></span>
</div>
<div id="tree">
</div>
<div id="dialogs">
	<table id="dataTable">
		<tr><td>Type</td><td class="data" id="type"></td></tr>
		<tr><td>Current Goal</td><td  class="data" id="current-goal"></td></tr>	
		<tr><td>Nested Denials</td><td  class="data" id="nested-denials"></td></tr>
		<tr><td>Next Goals</td><td  class="data" id="next-goals"></td></tr>
		<tr><td>Assignments</td><td  class="data" id="assignments"></td></tr>
		<tr><td>Abducibles</td><td  class="data" id="abducibles"></td></tr>
		<tr><td>Denials</td><td  class="data" id="denials"></td></tr>
		<tr><td>Equalities</td><td  class="data" id="equalities"></td></tr>
		<tr><td>Constraints</td><td  class="data" id="constraints"></td></tr>
		<tr><td>Mark</td><td  class="data" id="mark"></td></tr>
	</table>
</div>
</body>
</html>